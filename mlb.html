<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7,IE=9" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>Esri <3 d3js</title>
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/js/esri/css/esri.css">
    <style type="text/css">
      html, body { 
        height: 100%; width: 100%;
        margin: 0; padding: 0;
      } 
      body{
        background-color: #fff; overflow:hidden; 
        font-family: sans-serif;
      }
      #map {
        position:absolute;
        width: 100%;
        height: 100%;
      }
      #team {
        position:absolute;
        right: 5px;
        top:5px;
        border-radius: 5px; 
        border: 1px solid #555;
        /*width: 450px;
        height: 200px;*/
        background: #fff;
        display:none;
        font-size:36px;
        text-align: center;
        padding:20px;
      }
      .info {
        height: 100px;
      }

      #payroll {
        border-bottom: 1px solid #555;
      }

      .park{
        fill: #fff;
        stroke-width:4px;
        stroke: #002e5d;
        opacity: .75;
      }
      circle.node {
        stroke: #000;
        stroke-width: .5px;
      }
      circle.node:hover {
        cursor: pointer;
        stroke: #FFF;
        stroke-width: 4px;
      }
      
      line.link {
        fill: none;
        stroke: #444;
        stroke-width: 1px;
      }
      .park:hover {
        stroke: #d50032;
        stroke-width: 6px;
        cursor:pointer;
      }

    </style>
    <script>
      var dojoConfig = {
        parseOnLoad: true,
        packages: [{
          "name": "modules",
          "location": location.origin + location.pathname.replace(/\/[^/]+$/, '')
        }]
      };
    </script>
   
    <script src="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    
    <script>

      var payroll = d3.scale.quantile()
        .domain([50000000, 200000000])
        .range([5, 10, 15, 20, 25])

      var salary = d3.scale.quantile()
        .domain([200000, 20000000])
        .range([5, 10, 15, 20])

      dojo.require("esri.map");
      dojo.require("modules.d3Layer");

      dojo.ready(function(){
  
        var initExtent = new esri.geometry.Extent({
          "xmin":-132,
          "ymin":20,
          "xmax":-60,
          "ymax":50,
          "spatialReference": { 
            "wkid": 4326
          }
        });

        map = new esri.Map("map",{
          extent:esri.geometry.geographicToWebMercator(initExtent)
        });

        var basemap = new esri.layers.ArcGISTiledMapServiceLayer(
          "http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer");

        map.addLayer(basemap); 

        layer = new modules.d3Layer('data/mlb_salaries.json', {
          attrs: [
            { key: 'r', value: function(d){ return payroll(d.properties.team.payroll); } },
            { key: 'class', value: 'park' }
          ],
          type: 'circle'
        }); 
        map.addLayer(layer);
          
          
        dojo.connect(layer, "onLoad", function(lyr) {
            lyr._render();

            d3.selectAll('.park')
              .on('mouseover', function( dot ){
                d3.select('#team').style('display', 'block');
                d3.select('#salary').html(' ')
                d3.select('#payroll')
                  .html(dot.properties.team.name + '<br/>' + '$' + addCommas(dot.properties.team.payroll));
              })
              .on('mouseout', function( dot ){
                setTimeout(function(){
                  //d3.select('#team').style('display', 'none');
                  //d3.select('#payroll')
                  //  .html('');

                }, 3000);
              });

            d3.selectAll('.node')
              .on('mouseover', function( dot ){
                console.log(dot)
                d3.select('#salary')
                  .html(dot.properties.team.name + '<br/>' + dot.properties.team.payroll);
              })
            
            //add commas
            function addCommas(nStr) {
              nStr += '';
              x = nStr.split('.');
              x1 = x[0];
              x2 = x.length > 1 ? '.' + x[1] : '';
              var rgx = /(\d+)(\d{3})/;
              while (rgx.test(x1)) {
                x1 = x1.replace(rgx, '$1' + ',' + '$2');
              }
              return x1 + x2;
            }
            
            d3.selectAll('.park')
              .on('mouseup', function( dot ){
        
                var selected = d3.select(this)[0][0];

                var force = d3.layout.force()
                  .on("tick", tick)
                  
                var vis = lyr._element().append("g")
                    .attr('class', 'hover-force')
                    .attr('id', dot.properties.team.city.replace(' ', ''));
                
                var root = dot.properties;
                  root.fixed = true;
                  root.x = selected.cx.baseVal.value;
                  root.y = selected.cy.baseVal.value;
                
                var nodes = flatten(root),
                  links = d3.layout.tree().links(nodes);
                  
                force
                    .gravity(.06) 
                    .charge(-75)
                    .linkStrength(5)
                    .linkDistance(50)
                    .size([700, 700])
                    .nodes(nodes)
                    .links(links)
                    .start();
                
                vis.selectAll("line.link")
                  .data(links, function(d) { return d.target.id; })
                  .enter().insert("svg:line", ".node")
                    .attr("class", "link")
                    .attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });
                
                vis.selectAll("circle.node")
                    .data(nodes, function(d) { return d.id; })
                    .enter().append("svg:circle")
                      .attr("class", "node")
                      .attr("cx", function(d) { return d.x; })
                      .attr("cy", function(d) { return d.y; })
                      .attr("r", function(d) { return d.children ? payroll(d.team.payroll) : salary(d.salary) })
                      .style("fill", color)
                      .call(force.drag)
                      .on('click', function(d) {
                        if (d.team && d.team.city) d3.select('#' + d.team.city.replace(' ','')).remove();
                      })
                      .on('mouseover', function( dot ){
                        if ( !dot.team ) {
                          d3.select('#salary')
                            .html(dot.name +'<br/>'+ '$' + addCommas(dot.salary));
                        }
                      });
                    
                
                function tick() {
                  vis.selectAll("line.link")
                    .attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });
                
                  vis.selectAll("circle.node")
                    .attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; });
                }
                
                // MLB colors
                function color(d) {
                  return d._children ? "#d50032" : d.children ? "#FFF" : "#d50032";
                }
                
                // Returns a list of all nodes under the root.
                function flatten(root) {
                  var nodes = [], i = 0;
                
                  function recurse(node) {
                    if (node.children) node.salary = node.children.reduce(function(p, v) { return p + recurse(v); }, 0);
                    if (!node.id) node.id = ++i;
                    nodes.push(node);
                    return node.salary;
                  }
                
                  root.salary = recurse(root);
                  return nodes;
                }
                
            });
          });
        });

    </script>
  </head>
  <body class="tundra">
    <div id="map"></div>
    <div id="team">
      <div id="payroll" class="info"></div>
      <div id="salary" class="info"></div>
    </div>
  </body>
</html>
